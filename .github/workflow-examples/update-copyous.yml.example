name: Update Copyous

on:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: "0 0 * * 1"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-copyous:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(grep 'version = ' packages/package-copyous.nix | sed 's/.*version = "\(.*\)".*/\1/')
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Check for latest GitHub release
        id: latest_version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_VERSION=$(gh api repos/boerdereinar/copyous/releases/latest --jq '.tag_name' | sed 's/^v//')
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest version: $LATEST_VERSION"

      - name: Check if update needed
        id: check_update
        run: |
          if [ "${{ steps.current_version.outputs.version }}" != "${{ steps.latest_version.outputs.version }}" ]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "Update needed: ${{ steps.current_version.outputs.version }} -> ${{ steps.latest_version.outputs.version }}"
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
            echo "No update needed"
          fi

      - name: Calculate hash for new version
        if: steps.check_update.outputs.update_needed == 'true'
        id: new_hash
        run: |
          VERSION="${{ steps.latest_version.outputs.version }}"
          URL="https://github.com/boerdereinar/copyous/releases/download/v${VERSION}/copyous%40boerdereinar.dev.zip"

          echo "Fetching hash for: $URL"
          # nix-prefetch-url --unpack returns base32, convert to SRI format
          HASH_BASE32=$(nix-prefetch-url --unpack --name copyous.zip "$URL" 2>/dev/null)
          HASH_SRI=$(nix hash convert --hash-algo sha256 --to sri "$HASH_BASE32")

          echo "hash=$HASH_SRI" >> $GITHUB_OUTPUT
          echo "SHA256 (SRI): $HASH_SRI"

      - name: Update package-copyous.nix
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          NEW_VERSION="${{ steps.latest_version.outputs.version }}"
          NEW_HASH="${{ steps.new_hash.outputs.hash }}"

          sed -i "s/version = \".*\"/version = \"${NEW_VERSION}\"/" packages/package-copyous.nix
          sed -i "s|hash = \".*\"|hash = \"${NEW_HASH}\"|" packages/package-copyous.nix

          echo "Updated package-copyous.nix:"
          cat packages/package-copyous.nix

      - name: Create Pull Request
        if: steps.check_update.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(copyous): update to v${{ steps.latest_version.outputs.version }}"
          title: "chore(copyous): update copyous to v${{ steps.latest_version.outputs.version }}"
          body: |
            ## Automated Copyous Update

            This PR updates the Copyous GNOME extension from `${{ steps.current_version.outputs.version }}` to `${{ steps.latest_version.outputs.version }}`.

            ### Changes
            - Updated version in `packages/package-copyous.nix`
            - Updated SHA256 hash for the new release

            ### Release Notes
            See: https://github.com/boerdereinar/copyous/releases/tag/v${{ steps.latest_version.outputs.version }}

            ### Verification
            - [ ] Test locally with `nixos-rebuild build --flake .`
            - [ ] Verify extension loads in GNOME

            ---
            *This PR was created automatically by the [update-copyous](.github/workflows/update-copyous.yml) workflow.*
          branch: automated/update-copyous
          delete-branch: true
          labels: |
            dependencies
            automated
